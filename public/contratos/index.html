<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Contratos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial; background:#f7fafc; padding:24px }
    .card { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(2,6,23,0.06) }
    h1 { margin-bottom:12px; font-size:20px }
    .subtitle { color:#64748b; margin-bottom:24px; font-size:13px }
    .mes-selector { margin-bottom:24px; display:flex; gap:12px; align-items:center }
    .mes-selector label { font-weight:600; font-size:14px }
    .mes-selector select { padding:8px 12px; border:1px solid #e2e8f0; border-radius:4px; font-size:14px; cursor:pointer }
    .section { margin-bottom:32px }
    .section-title { font-weight:600; margin-bottom:12px; color:#0f172a; font-size:14px }
    .chart-container { position: relative; height: 350px; width: 100%; margin-bottom:32px }
    .chart-circular-wrapper { max-width: 400px; margin: 0 auto; margin-bottom:32px }
    .chart-circular { position: relative; height: 350px; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { background: #f1f5f9; padding: 8px; text-align: left; border: 1px solid #e2e8f0; font-weight: 600; font-size: 12px; }
    .data-table td { padding: 8px; border: 1px solid #e2e8f0; font-size: 14px; }
  </style>
  <script src="../components/auth.js" defer></script>
  <script src="../components/nav-bar-custom.js" defer></script>
</head>
<body>
  <nav-bar-custom></nav-bar-custom>
  <div class="card">
    <h1>Contratos</h1>    
    <div class="mes-selector">
      <label for="mesSelect">Seleccionar mes:</label>
      <select id="mesSelect">
        <option value="">Cargando meses...</option>
      </select>
    </div>
    
    <div class="section">
      <div class="section-title">Tipo de Contrato</div>
      <div class="chart-container">
        <canvas id="chartTipoContrato"></canvas>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th>Tipo de Contrato</th>
            <th>Total de Ventas</th>
          </tr>
        </thead>
        <tbody id="tablaTipoContrato">
        </tbody>
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">Segmentación de Ventas</div>
      <div class="chart-circular-wrapper">
        <div class="chart-circular">
          <canvas id="chartSegmentacion"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Verificar autenticación
    if (!Auth.isAuthenticated()) {
      window.location.href = '/login';
    }

    let mesesDisponibles = [];

    async function cargarMeses() {
      try {
        const res = await Auth.fetch('/facturas/meses');
        const json = await res.json();
        mesesDisponibles = json.data || [];
        
        const select = document.getElementById('mesSelect');
        select.innerHTML = '';
        
        mesesDisponibles.forEach(mes => {
          const option = document.createElement('option');
          option.value = mes;
          const [mesNum, año] = mes.split('-');
          const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
          option.textContent = `${meses[parseInt(mesNum) - 1]} ${año}`;
          select.appendChild(option);
        });
        
        if (mesesDisponibles.length > 0) {
          select.value = mesesDisponibles[0];
        }
      } catch (e) {
        if (e.message === 'AUTH_REQUIRED') {
          window.location.href = '/login';
          return;
        }
        console.error('Error cargando meses:', e);
      }
    }

    async function fetchData(mes) {
      try {
        const url = mes 
          ? `/facturas/contratos?mes=${mes}`
          : '/facturas/contratos';
        const res = await Auth.fetch(url);
        const json = await res.json();
        return json.data;
      } catch(e) {
        if (e.message === 'AUTH_REQUIRED') {
          window.location.href = '/login';
          return null;
        }
        console.error(e);
        return null;
      }
    }

    const COLORS = {
      B2B: '#0ea5a4',
      MARKETPLACE: '#f97316'
    };

    function mapContractType(numeroContrato) {
      const cleaned = numeroContrato.trim().toLowerCase();
      switch(cleaned) {
        case '0001': return 'Nuevos';
        case '0002': return 'Recompra';
        case 'orientación vocacional': return 'Orientación Vocacional';
        case 'conócete': return 'Conócete';
        default: return 'Otros';
      }
    }

    function getSegmentationType(numeroContrato) {
      return (numeroContrato === '0001' || numeroContrato === '0002') ? 'B2B' : 'Marketplace';
    }

    function getColorByContractType(tipoContrato) {
      if (tipoContrato === 'Nuevos' || tipoContrato === 'Recompra') {
        return COLORS.B2B;
      }
      return COLORS.MARKETPLACE;
    }

    function formatMoney(v) {
      return new Intl.NumberFormat('es-AR', {
        style: 'currency',
        currency: 'ARS'
      }).format(v);
    }

    async function render(mes) {
      const resultado = await fetchData(mes);
      if (!resultado) return;

      const contratos = resultado.datos;

      const tipoContratoMap = {};
      const segmentacionMap = { 'B2B': 0, 'Marketplace': 0 };

      contratos.forEach(c => {
        const tipoContrato = mapContractType(c.numeroContrato);
        const segmentacion = getSegmentationType(c.numeroContrato);
        
        if (!tipoContratoMap[tipoContrato]) {
          tipoContratoMap[tipoContrato] = 0;
        }

        tipoContratoMap[tipoContrato] += c.totalVentas;
        segmentacionMap[segmentacion] += c.cantidad;
      });

      // Gráfico barras - Ordenar en orden fijo
      const ctx1 = document.getElementById('chartTipoContrato').getContext('2d');
      const ordenFijo = ['Nuevos', 'Recompra', 'Orientación Vocacional', 'Conócete', 'Otros'];
      const tipoContratoLabels = ordenFijo.filter(label => tipoContratoMap[label] !== undefined);
      const tipoContratoValues = tipoContratoLabels.map(label => tipoContratoMap[label]);
      const tipoContratoColors = tipoContratoLabels.map(label => getColorByContractType(label));

      if (window._chart1) window._chart1.destroy();

      window._chart1 = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: tipoContratoLabels,
          datasets: [{ 
            label: 'Total de ventas', 
            data: tipoContratoValues, 
            backgroundColor: tipoContratoColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } },
          plugins: { 
            legend: { display: true }, 
            tooltip: { callbacks: { label: ctx => `$${ctx.raw.toLocaleString()}` } } 
          }
        }
      });

      // Tabla de datos
      const tbody = document.getElementById('tablaTipoContrato');
      tbody.innerHTML = tipoContratoLabels.map(label => `
        <tr>
          <td><strong>${label}</strong></td>
          <td>${formatMoney(tipoContratoMap[label])}</td>
        </tr>
      `).join('');

      // Gráfico circular
      const ctx2 = document.getElementById('chartSegmentacion').getContext('2d');
      if (window._chart2) window._chart2.destroy();

      window._chart2 = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: Object.keys(segmentacionMap),
          datasets: [{ 
            data: Object.values(segmentacionMap), 
            backgroundColor: [COLORS.B2B, COLORS.MARKETPLACE]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'bottom' },
            tooltip: { callbacks: { label: ctx => { const total = Object.values(segmentacionMap).reduce((a, b) => a + b, 0); const percentage = ((ctx.raw / total) * 100).toFixed(1); return `${ctx.label}: ${ctx.raw} ventas (${percentage}%)`; } } }
          }
        }
      });
    }

    (async () => {
      await cargarMeses();
      const mesSelect = document.getElementById('mesSelect');
      
      await render(mesSelect.value);

      mesSelect.addEventListener('change', async (e) => {
        await render(e.target.value);
      });
    })();
  </script>
</body>
</html>