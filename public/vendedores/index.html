<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ranking de Vendedores</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial; background:#f7fafc; padding:24px }
    .card { max-width:1000px; margin:auto; background:#fff; padding:20px; border-radius:8px }
    h1 { margin-bottom:4px }
    .total { font-size:16px; font-weight:600; margin-bottom:16px }
    canvas { max-width:100%; height:420px }
  </style>
</head>
<body>
  <div class="card">
    <h1>Ranking de vendedores</h1>
    <div id="total" class="total">Cargando...</div>
    <canvas id="chart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function fetchData() {
      const res = await fetch('/facturas/ranking-vendedores');
      const json = await res.json();
      return json.data;
    }

    function formatMoney(v) {
      return new Intl.NumberFormat('es-AR', {
        style: 'currency',
        currency: 'ARS'
      }).format(v);
    }

    async function render() {
      let data = await fetchData();

      // ðŸ”¹ ordenar por ingresos (desc)
      data.sort((a, b) => b.ingresos - a.ingresos);

      // ðŸ”¹ totales generales
      const totalIngresos = data.reduce((s, d) => s + d.ingresos, 0);
      const totalVentas = data.reduce((s, d) => s + d.cantidadVentas, 0);

      document.getElementById('total').textContent =
        `Ingresos totales: ${formatMoney(totalIngresos)} Â· Ventas: ${totalVentas}`;

      const labels = data.map(d => d.vendedor);
      const ingresos = data.map(d => d.ingresos);
      const ventas = data.map(d => d.cantidadVentas);

      // ðŸ”¹ Normalizar datos para que se vean al mismo nivel
      const maxIngresos = Math.max(...ingresos);
      const maxVentas = Math.max(...ventas);
      
      const ingresosNormalizados = ingresos.map(v => (v / maxIngresos) * 100);
      const ventasNormalizadas = ventas.map(v => (v / maxVentas) * 100);

      const ctx = document.getElementById('chart').getContext('2d');

      new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
            {
                label: 'Ingresos',
                data: ingresosNormalizados,
                backgroundColor: '#22c55e',
                yAxisID: 'yNormalizado'
            },
            {
                label: 'Cantidad de ventas',
                data: ventasNormalizadas,
                backgroundColor: '#60a5fa',
                yAxisID: 'yNormalizado'
            }
            ]
        },
        options: {
            responsive: true,
            scales: {
            yNormalizado: {
                type: 'linear',
                position: 'left',
                beginAtZero: true,
                min: 0,
                max: 100,
                ticks: {
                callback: v => `${v}%`
                },
                title: {
                display: true,
                text: 'ProporciÃ³n (%)'
                }
            }
            },
            plugins: {
            tooltip: {
                callbacks: {
                label: ctx => {
                    if (ctx.dataset.label === 'Ingresos') {
                    const idx = ctx.dataIndex;
                    return `${formatMoney(ingresos[idx])}`;
                    } else {
                    const idx = ctx.dataIndex;
                    return `${ventas[idx]} ventas`;
                    }
                }
                }
            }
            }
        }
        });

    }

    render();
  </script>
</body>
</html>