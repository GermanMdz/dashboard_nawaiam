import { Router } from 'express';
import { FacturaController } from '../controllers/factura.controller';
import { FacturaService } from '../../application/services/factura.service';
import { FacturaRepository } from '../../application/repositories/factura.repository';
import { FinnegansHttp } from '../../infrastructure/http/finnegans.http';

export function createFacturaRoutes(http: FinnegansHttp): Router {
  const router = Router();

  // Inyección de dependencias
  const repository = new FacturaRepository(http);
  const service = new FacturaService(repository);
  const controller = new FacturaController(service);

  // Rutas
  router.get('/dashboardGeneral', (req, res) => controller.obtenerDashboardGeneral(req, res));
  router.get('/ventas-por-producto', (req, res) => controller.obtenerVentasXProducto(req, res));
  router.get('/ranking-vendedores', (req, res) => controller.obtenerRankingVendedores(req, res));
  router.get('/', (req, res) => controller.obtenerTodas(req, res));
  
  // borrar caché:
  router.post('/cache/refresh', async (req, res) => {
    try {
      await repository.invalidarCache();
      res.json({
        success: true,
        message: 'Caché eliminada, próxima petición traerá datos frescos'
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        error: 'Error limpiando caché'
      });
    }
  });
  return router;
}
